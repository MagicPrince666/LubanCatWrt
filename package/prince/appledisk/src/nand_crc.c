
#include <debug.h>
#include <common.h>
#include <malloc.h>
#include "asm/io.h"
#include "configs/rt2880.h"
#include "rt_mmap.h"

#include "nvme.h"

#ifndef uint64_t
#define uint64_t long long
#endif
#if(1)
const unsigned int ecc_table2[512] = {
	0xa0050000,0xe8810000,0xa88d8000,0xe0098000,0xc0950000,0x88110000,0xc81d8000,0x80998000,0x80a58000,0xc8218000,0x882d0000,0xc0a90000,0xe0358000,0xa8b18000,0xe8bd0000,0xa0390000,0xe0c58000,0xa8418000,0xe84d0000,0xa0c90000,0x80558000,0xc8d18000,0x88dd0000,0xc0590000,0xc0650000,0x88e10000,0xc8ed8000,0x80698000,0xa0f50000,0xe8710000,0xa87d8000,0xe0f98000,
	0xc9050000,0x81810000,0xc18d8000,0x89098000,0xa9950000,0xe1110000,0xa11d8000,0xe9998000,0xe9a58000,0xa1218000,0xe12d0000,0xa9a90000,0x89358000,0xc1b18000,0x81bd0000,0xc9390000,0x89c58000,0xc1418000,0x814d0000,0xc9c90000,0xe9558000,0xa1d18000,0xe1dd0000,0xa9590000,0xa9650000,0xe1e10000,0xa1ed8000,0xe9698000,0xc9f50000,0x81710000,0xc17d8000,0x89f98000,
	0x8a058000,0xc2818000,0x828d0000,0xca090000,0xea958000,0xa2118000,0xe21d0000,0xaa990000,0xaaa50000,0xe2210000,0xa22d8000,0xeaa98000,0xca350000,0x82b10000,0xc2bd8000,0x8a398000,0xcac50000,0x82410000,0xc24d8000,0x8ac98000,0xaa550000,0xe2d10000,0xa2dd8000,0xea598000,0xea658000,0xa2e18000,0xe2ed0000,0xaa690000,0x8af58000,0xc2718000,0x827d0000,0xcaf90000,
	0xe3058000,0xab818000,0xeb8d0000,0xa3090000,0x83958000,0xcb118000,0x8b1d0000,0xc3990000,0xc3a50000,0x8b210000,0xcb2d8000,0x83a98000,0xa3350000,0xebb10000,0xabbd8000,0xe3398000,0xa3c50000,0xeb410000,0xab4d8000,0xe3c98000,0xc3550000,0x8bd10000,0xcbdd8000,0x83598000,0x83658000,0xcbe18000,0x8bed0000,0xc3690000,0xe3f58000,0xab718000,0xeb7d0000,0xa3f90000,
	0xec058000,0xa4818000,0xe48d0000,0xac090000,0x8c958000,0xc4118000,0x841d0000,0xcc990000,0xcca50000,0x84210000,0xc42d8000,0x8ca98000,0xac350000,0xe4b10000,0xa4bd8000,0xec398000,0xacc50000,0xe4410000,0xa44d8000,0xecc98000,0xcc550000,0x84d10000,0xc4dd8000,0x8c598000,0x8c658000,0xc4e18000,0x84ed0000,0xcc690000,0xecf58000,0xa4718000,0xe47d0000,0xacf90000,
	0x85058000,0xcd818000,0x8d8d0000,0xc5090000,0xe5958000,0xad118000,0xed1d0000,0xa5990000,0xa5a50000,0xed210000,0xad2d8000,0xe5a98000,0xc5350000,0x8db10000,0xcdbd8000,0x85398000,0xc5c50000,0x8d410000,0xcd4d8000,0x85c98000,0xa5550000,0xedd10000,0xaddd8000,0xe5598000,0xe5658000,0xade18000,0xeded0000,0xa5690000,0x85f58000,0xcd718000,0x8d7d0000,0xc5f90000,
	0xc6050000,0x8e810000,0xce8d8000,0x86098000,0xa6950000,0xee110000,0xae1d8000,0xe6998000,0xe6a58000,0xae218000,0xee2d0000,0xa6a90000,0x86358000,0xceb18000,0x8ebd0000,0xc6390000,0x86c58000,0xce418000,0x8e4d0000,0xc6c90000,0xe6558000,0xaed18000,0xeedd0000,0xa6590000,0xa6650000,0xeee10000,0xaeed8000,0xe6698000,0xc6f50000,0x8e710000,0xce7d8000,0x86f98000,
	0xaf050000,0xe7810000,0xa78d8000,0xef098000,0xcf950000,0x87110000,0xc71d8000,0x8f998000,0x8fa58000,0xc7218000,0x872d0000,0xcfa90000,0xef358000,0xa7b18000,0xe7bd0000,0xaf390000,0xefc58000,0xa7418000,0xe74d0000,0xafc90000,0x8f558000,0xc7d18000,0x87dd0000,0xcf590000,0xcf650000,0x87e10000,0xc7ed8000,0x8f698000,0xaff50000,0xe7710000,0xa77d8000,0xeff98000,
	0xd0058000,0x98818000,0xd88d0000,0x90090000,0xb0958000,0xf8118000,0xb81d0000,0xf0990000,0xf0a50000,0xb8210000,0xf82d8000,0xb0a98000,0x90350000,0xd8b10000,0x98bd8000,0xd0398000,0x90c50000,0xd8410000,0x984d8000,0xd0c98000,0xf0550000,0xb8d10000,0xf8dd8000,0xb0598000,0xb0658000,0xf8e18000,0xb8ed0000,0xf0690000,0xd0f58000,0x98718000,0xd87d0000,0x90f90000,
	0xb9058000,0xf1818000,0xb18d0000,0xf9090000,0xd9958000,0x91118000,0xd11d0000,0x99990000,0x99a50000,0xd1210000,0x912d8000,0xd9a98000,0xf9350000,0xb1b10000,0xf1bd8000,0xb9398000,0xf9c50000,0xb1410000,0xf14d8000,0xb9c98000,0x99550000,0xd1d10000,0x91dd8000,0xd9598000,0xd9658000,0x91e18000,0xd1ed0000,0x99690000,0xb9f58000,0xf1718000,0xb17d0000,0xf9f90000,
	0xfa050000,0xb2810000,0xf28d8000,0xba098000,0x9a950000,0xd2110000,0x921d8000,0xda998000,0xdaa58000,0x92218000,0xd22d0000,0x9aa90000,0xba358000,0xf2b18000,0xb2bd0000,0xfa390000,0xbac58000,0xf2418000,0xb24d0000,0xfac90000,0xda558000,0x92d18000,0xd2dd0000,0x9a590000,0x9a650000,0xd2e10000,0x92ed8000,0xda698000,0xfaf50000,0xb2710000,0xf27d8000,0xbaf98000,
	0x93050000,0xdb810000,0x9b8d8000,0xd3098000,0xf3950000,0xbb110000,0xfb1d8000,0xb3998000,0xb3a58000,0xfb218000,0xbb2d0000,0xf3a90000,0xd3358000,0x9bb18000,0xdbbd0000,0x93390000,0xd3c58000,0x9b418000,0xdb4d0000,0x93c90000,0xb3558000,0xfbd18000,0xbbdd0000,0xf3590000,0xf3650000,0xbbe10000,0xfbed8000,0xb3698000,0x93f50000,0xdb710000,0x9b7d8000,0xd3f98000,
	0x9c050000,0xd4810000,0x948d8000,0xdc098000,0xfc950000,0xb4110000,0xf41d8000,0xbc998000,0xbca58000,0xf4218000,0xb42d0000,0xfca90000,0xdc358000,0x94b18000,0xd4bd0000,0x9c390000,0xdcc58000,0x94418000,0xd44d0000,0x9cc90000,0xbc558000,0xf4d18000,0xb4dd0000,0xfc590000,0xfc650000,0xb4e10000,0xf4ed8000,0xbc698000,0x9cf50000,0xd4710000,0x947d8000,0xdcf98000,
	0xf5050000,0xbd810000,0xfd8d8000,0xb5098000,0x95950000,0xdd110000,0x9d1d8000,0xd5998000,0xd5a58000,0x9d218000,0xdd2d0000,0x95a90000,0xb5358000,0xfdb18000,0xbdbd0000,0xf5390000,0xb5c58000,0xfd418000,0xbd4d0000,0xf5c90000,0xd5558000,0x9dd18000,0xdddd0000,0x95590000,0x95650000,0xdde10000,0x9ded8000,0xd5698000,0xf5f50000,0xbd710000,0xfd7d8000,0xb5f98000,
	0xb6058000,0xfe818000,0xbe8d0000,0xf6090000,0xd6958000,0x9e118000,0xde1d0000,0x96990000,0x96a50000,0xde210000,0x9e2d8000,0xd6a98000,0xf6350000,0xbeb10000,0xfebd8000,0xb6398000,0xf6c50000,0xbe410000,0xfe4d8000,0xb6c98000,0x96550000,0xded10000,0x9edd8000,0xd6598000,0xd6658000,0x9ee18000,0xdeed0000,0x96690000,0xb6f58000,0xfe718000,0xbe7d0000,0xf6f90000,
	0xdf058000,0x97818000,0xd78d0000,0x9f090000,0xbf958000,0xf7118000,0xb71d0000,0xff990000,0xffa50000,0xb7210000,0xf72d8000,0xbfa98000,0x9f350000,0xd7b10000,0x97bd8000,0xdf398000,0x9fc50000,0xd7410000,0x974d8000,0xdfc98000,0xff550000,0xb7d10000,0xf7dd8000,0xbf598000,0xbf658000,0xf7e18000,0xb7ed0000,0xff690000,0xdff58000,0x97718000,0xd77d0000,0x9FF90000,
};
//-----------------------------------------------------------------------------------------------------------
unsigned int get_odd_parity64(uint64_t v18)
{
	uint64_t v19, v20;
	v19 = ((v18 - ((v18 >> 1) & 0x5555555555555555)) & 0x3333333333333333)
		+ (((v18 - ((v18 >> 1) & 0x5555555555555555)) >> 2) & 0x3333333333333333);
	v20 = (0x101010101010101 * ((v19 + (v19 >> 4)) & 0xF0F0F0F0F0F0F0F)) >> 56;
	return v20;
}
//-----------------------------------------------------------------------------------------------------------
unsigned int calc_page_ecc(unsigned char* page_buffer, unsigned int len)
{
	unsigned int i, ecc, xor32;
	uint64_t *page_buffer64, v64;		uint16_t b48, b32, b16, b00;

	page_buffer64 = (uint64_t*)page_buffer;
	for (i = 0, ecc = 0, v64 = 0; i < 512; i++) {
		v64 ^= page_buffer64[i];
		if (get_odd_parity64(page_buffer64[i]) % 2) {
			ecc ^= ecc_table2[i];
		}
	}

	b48 = (v64 >> 48) & 0xffff;		b48 = get_odd_parity64(b48) % 2;
	b32 = (v64 >> 32) & 0xffff;		b32 = get_odd_parity64(b32) % 2;
	b16 = (v64 >> 16) & 0xffff;		b16 = get_odd_parity64(b16) % 2;
	b00 = (v64 >> 0) & 0xffff;		b00 = get_odd_parity64(b00) % 2;
	if (b48)		ecc ^= 0x80008000;
	if (b32)		ecc ^= 0x00000000;
	if (b16)		ecc ^= 0xa8828000;
	if (b00)		ecc ^= 0x28820000;

	xor32 = (((v64 >> 32) & 0xffffffff) ^ (v64 & 0xffffffff));
	xor32 = ((xor32 & 0xffff0000) ^ ((xor32 << 16) & 0xffff0000));
	ecc ^= xor32;

	return ecc;
}
//-----------------------------------------------------------------------------------------------------------
unsigned int calc_meta_ecc(unsigned char* meta_buffer, unsigned int len)
{
	uint16_t b16, b00;		unsigned int meta_xor32, ecc;
	uint32_t* pMeta32 = (uint32_t *)meta_buffer;
	meta_xor32 = pMeta32[0] ^ pMeta32[1] ^ pMeta32[2];
	b16 = (meta_xor32 >> 16) & 0xffff;		b16 = get_odd_parity64(b16) % 2;
	b00 = (meta_xor32 >> 0) & 0xffff;		b00 = get_odd_parity64(b00) % 2;

	if ((pMeta32[0] == 0xffffff05) || (pMeta32[0] == 0xffffff06) || (pMeta32[0] == 0xffffff09) \
		|| (pMeta32[0] == 0xffffff0C) || (pMeta32[0] == 0xffffff31)) {
		ecc = ((meta_xor32 & 0xffff0000) ^ ((meta_xor32 << 16) & 0xffff0000));
		if (b00)   ecc ^= 0xa8828000;
		if (b16)   ecc ^= 0x28820000;
		if (pMeta32[0] == 0xffffff31)	ecc ^= 0x48840000;
	}
	else {
		ecc = ((meta_xor32 & 0xffff0000) ^ ((meta_xor32 << 16) & 0xffff0000));
		if (b00)   ecc ^= 0xa8828000;
		if (b16)   ecc ^= 0x28820000;
		ecc ^= 0x48840000;
	}
	return ecc;
}
#endif
//-----------------------------------------------------------------------------------------------------------
int ecc_vertify_page(unsigned char* page_buffer,unsigned char* meta_buffer)
{
#if(1)
	unsigned int *page_buffer32,*meta_buffer32;
	unsigned int i,page_ecc32,meta_ecc32,wp_ecc;
	page_buffer32 = (unsigned int*)page_buffer;
	meta_buffer32 = (unsigned int*)meta_buffer;
	page_ecc32 = calc_page_ecc(&page_buffer[0], 4096);			//calculate the page data
	meta_ecc32 = calc_meta_ecc(&meta_buffer[0], 12);		//calculate the meta data
	//calculate the ecc from page and meta buffer
	wp_ecc = page_ecc32 ^ meta_ecc32;
	meta_buffer32[3] = wp_ecc;
	if ((meta_buffer32[0] == 0xffffff31) && (page_buffer32[0] == 0xdeadbeef) && (page_buffer32[1] == 0xdeadbeef)) {
		for (i = 0; i < 1024; i++)	page_buffer32[i] = 0xdeadbeef;
	}
#endif

	return 0;
}
//-----------------------------------------------------------------------------------------------------------
int ecc_vertify_crc(unsigned char* page_buffer,unsigned int len)
{
	unsigned int i = 0,crc = 0;
	for(i=0;i<len;i++)
		crc += page_buffer[i];
	return crc;
}
//-----------------------------------------------------------------------------------------------------------

